<!DOCTYPE html>
<html id="html">

<head>
<meta charset="UTF-8">
<title>Tinypet GQ</title>
<!-- Google API -->
<meta name="google-signin-client_id" content="357396347490-ql96pef4k22d74et2vspfa7fotj908c2.apps.googleusercontent.com">
<meta name="google-signin-plugin_name" content="stop bugging me">
<!-- Adaptation à la taille de l'écran -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Fiche de css perso -->
<link rel="stylesheet" type="text/css" href="style.css" media="all"/>
<!-- CSS bulam -->
<link rel="stylesheet" type="text/css" href="bulma.css" media="all"/>
<!-- Font pour le texte -->
<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
<!-- Mithril -->
<script src="https://unpkg.com/mithril/mithril.js"></script>
</head>


<body class="has-navbar-fixed-top" id="body">


<script>
//Variable de connexion
var userConnecter = 
{
		id : null,
		prenom : "",
};
var currentURL = "/";
//Variable de connexion avec l'API PetitionEndpoint
var hostApi = "https://gregoire-quentin-wc.ew.r.appspot.com/_ah/api/myApi/v1";
//Variable de notification
var notification = 
{
		message: "",
		close: true,
		Duree: 0,
		DureeMax:2000,
		Step: 500,
		classSup:"",
		id:null
}

//Temps depuis le lancement de la notification
var intervalNotificationId = null;
//Termine la notification
function closeNotification(id="notification") 
{
  clearInterval(intervalNotificationId);
  notification.close=true;
  notification.message="";
  notification.classSup="";
  document.getElementById(id).classList.add('hide');
}
//Montre la notification
function showNotification() 
{
	notification.Duree+=notification.Step;
    if(notification.Duree >= notification.DureeMax)
    {
    	closeNotification(notification.id);	
    }
}
//Lance une notification
function startNotification(message,classSup="is-primary",id="notification")
{
    notification.Duree = 0;
    notification.message=message;
    notification.classSup=classSup;
    notification.close=false;
    notification.id=id;
    document.getElementById(id).classList.remove('hide');
    
    intervalNotificationId = setInterval(showNotification, notification.Step); //Permet d'afficher la notif pendant step seconde
}

//Change la vue pour l'affichage d'une pétiton après une modification
function UpdatedCardPetitionInView(index)
{
	var cardView= document.getElementsByClassName("card slider")[index];
	
	cardView.getElementsByClassName("title")[0].innerHTML = Api_CrudPetition.item.titre;
	cardView.getElementsByClassName("subtitle")[0].innerHTML = Api_CrudPetition.item.description;
	var pourcent = Math.ceil(100*Api_CrudPetition.item.nbSignataire/Api_CrudPetition.item.objectifSignataire);
	if(Api_CrudPetition.item.objectifSignataire == 0) 
    {
		pourcent = 100;
	}
	cardView.getElementsByTagName("progress")[0].outerHTML ="<progress value="+pourcent+" max=\"100\" class=\"progress is-success\"></progress>";
	cardView.getElementsByTagName("strong")[0].innerHTML = Api_CrudPetition.item.nbSignataire+" personnes ont signé";
	cardView.getElementsByTagName("span")[0].innerHTML = " d'un objectif de "+ Api_CrudPetition.item.objectifSignataire+" signatures";
	if(validURL(Api_CrudPetition.item.img_url)){
		cardView.getElementsByTagName("img")[0].src = Api_CrudPetition.item.img_url;
	}	
}

//Met à jour la vue après la signature ou le retrait de signature
function UpdatedNbSignatureInView()
{
	var cardView= document.getElementsByClassName("card slider")[API_infoPetition.index];
	
	var pourcent = Math.ceil(100*API_infoPetition.item.nbSignataire/API_infoPetition.item.objectifSignataire);
	   if(API_infoPetition.item.objectifSignataire == 0) {
		   pourcent = 100;
	   }
	cardView.getElementsByTagName("progress")[0].outerHTML ="<progress value="+pourcent+" max=\"100\" class=\"progress is-success\"></progress>";

	cardView.getElementsByTagName("strong")[0].innerHTML = API_infoPetition.item.nbSignataire+" personnes ont signé ";

}

//retour en haut de la page
function scrollToTop() {
	window.scrollTo({top: 0});
}
	
//Login google
function onSignIn(googleUser) 
{
    var profile = googleUser.getBasicProfile();
    userConnecter.id =profile.getId();
    userConnecter.prenom = ""+profile.getGivenName();
    document.getElementById("login_google").classList.add('hide');
    document.getElementById("logout_google").classList.remove('hide');
}

//Logout google
function signOut() 
{
  var auth2 = gapi.auth2.getAuthInstance();
  auth2.signOut().then(function () 
  {
	  userConnecter.id = null;
	  userConnecter.prenom = "";
	  document.getElementById("login_google").classList.remove('hide');
	  document.getElementById("logout_google").classList.add('hide');
  });
}

//Montre l'affichage permettant la modification ou la création de pétition
function ShowCreateAndUpdatePetitionView(idItem=null,index=null)
{
	if(idItem==null)
    {
		Api_CrudPetition.item = getPetitionObject();
		Api_CrudPetition.index = null;
	} 
    else 
    {
		API_infoPetition.index = index;
		API_infoPetition.loadPetition(idItem);
		Api_CrudPetition.index = index;		
	}
	
	document.getElementById("CreateAndUpdatePetitionView").classList.add('is-active');
	document.getElementById("html").classList.add('is-clipped');
}

//Cache l'affichage permettant la modification ou la création de pétition
function HideCreateAndUpdatePetitionView()
{
	document.getElementById("CreateAndUpdatePetitionView").classList.remove('is-active');
	document.getElementById("html").classList.remove('is-clipped');
	Api_CrudPetition.item = getPetitionObject();
}

//Vérification de la forme de l'URL
function validURL(str) {
	  var pattern = new RegExp('^(https?:\\/\\/)?'+ // protocol
	    '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|'+ // domain name
	    '((\\d{1,3}\\.){3}\\d{1,3}))'+ // OR ip (v4) address
	    '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*'+ // port and path
	    '(\\?[;&a-z\\d%_.~+=-]*)?'+ // query string
	    '(\\#[-a-z\\d_]*)?$','i'); // fragment locator
	  return !!pattern.test(str);
}

//Affiche le détail de la pétiton
function ShowDetailPetitionView()
{
	document.getElementById("DetailPetitionView").classList.add('is-active');
	document.getElementById("html").classList.add('is-clipped');
}
//Cache le détail de la pétition
function HideDetailPetitionView() 
{
	document.getElementById("DetailPetitionView").classList.remove('is-active');
	document.getElementById("html").classList.remove('is-clipped');
}

//Création d'une pétition vide
function getPetitionObject() 
{
	return item= 
    {
		ID : null,
		theme : null,
		titre : null,
		description : null,
		date: null,
		update_at : null,
		proprietaire : userConnecter.id,
		nbSignataire : 0,
		objectifSignataire : 0,
		tag : null,
		tag_string : null,
		img_url : null
	}
}

//Récupère les 10 pétitons les plus récentes
var Top10NewPetitions = 
{
    list: [],
    previous: ["0"],
    next: ["0"],
    loadList: function(idItem) 
    {
        return m.request(
        {
            method: "GET",
            url: hostApi+"/petition/news/top10/:id",
            params: {id: idItem}
        })
        .then(function(result) 
        {
            
            Top10NewPetitions.list = result.items;
            scrollToTop();
            var last =result.items[result.items.length - 1].key.name;
            var previousNext = Top10NewPetitions.next[Top10NewPetitions.next.length - 1];
            if (previousNext == undefined)
            {
                previousNext =0;
            }
            if (last > previousNext) 
            {
                Top10NewPetitions.previous.push(previousNext);
                Top10NewPetitions.next.push(last);
            }
            if (last <= previousNext && Top10NewPetitions.previous.length >2)
            {

                Top10NewPetitions.previous.pop();
                Top10NewPetitions.next.pop();
            }
        })
	}
}

//Récupère les 10 pétitions avec le plus de signature
var Top10SignedPetitions = 
{
	    list: [],
	    previous: ["0"],
	    next: ["0"],
	    pageSuivante:true,
	    loadList: function(idItem) 
        {
	        return m.request(
            {
	            method: "GET",
	            url:  hostApi+"/petition/signed/top10/:id",
	            params: {id: idItem}
	        })
	        .then(function(result) 
            {
        		Top10SignedPetitions.list = result.items;
	        	scrollToTop();
	        	var last =result.items[result.items.length - 1].properties.nextPage;
	        	var previousNext = Top10SignedPetitions.next[Top10SignedPetitions.next.length - 1];
	        	if (previousNext == undefined)
                {
	        		previousNext =0;
	        	}
	        	if (Top10SignedPetitions.pageSuivante) 
                {
	        		Top10SignedPetitions.previous.push(previousNext);
	        		Top10SignedPetitions.next.push(last);
	        	}
	        	if (!Top10SignedPetitions.pageSuivante && Top10SignedPetitions.previous.length >2)
                {
	        		Top10SignedPetitions.previous.pop();
	        		Top10SignedPetitions.next.pop();
	        	}          
	        })
	}
}

//Permet de récupérer  les information d'une pétition
var API_infoPetition = 
{
    index:0,
    item: getPetitionObject(),
    loadPetition: function(idItem) 
    {
        return m.request(
        {
            method: "GET",
            url:  hostApi+"/petition/info/:id",
            params: {id: idItem}
        })
        .then(function(result) 
        {
            API_infoPetition.item = result.properties
            Api_CrudPetition.item = result.properties
            Api_CrudPetition.item.ID= result.key.name

        })
	}
}

//Fonctions permettant de savoir si une pétiton est signée ou non, d'ajouter ou de retirer une signature
var API_SignaturePetition = 
{
    isSigned: false,
    verifieSignature: function(idItem) 
    {
        return m.request(
        {
            method: "GET",
            url:  hostApi+"/signature/verifie/:petitionID/:userID",
            params: {petitionID: idItem,userID:userConnecter.id}
        })
        .then(function(result) 
        {
            API_SignaturePetition.isSigned = result.properties.signed

        })
    },
    addSignature: function(idItem) 
    {
        return m.request(
        {
            method: "POST",
            url:  hostApi+"/signature/add/:petitionID/:userID",
            params: {petitionID: idItem,userID:userConnecter.id}
        })
        .then(function(result) 
        {
            startNotification(result.properties.message);
            API_SignaturePetition.isSigned=true;
            API_infoPetition.item.nbSignataire++;
            UpdatedNbSignatureInView();
        })
    
    },
    deleteSignature: function(idItem) 
    {
        return m.request(
        {
            method: "DELETE",
            url:  hostApi+"/signature/delete/:petitionID/:userID",
            params: {petitionID: idItem,userID:userConnecter.id}
        })
        .then(function(result) 
        {
            startNotification(result.properties.message);
            API_SignaturePetition.isSigned=false;
            API_infoPetition.item.nbSignataire--;
            UpdatedNbSignatureInView();

        })
    }
}

//
var API_MyPetitionCreated = 
{
    list: [],
    previous: ["0"],
    next: ["0"],
    loadList: function(idItem) 
    {   
        return m.request(
        {
            method: "GET",
            url:  hostApi+"/petition/created/:userID/:last",
            params: {userID:userConnecter.id, last: idItem}
        })
        .then(function(result) 
        {
            API_MyPetitionCreated.list = result.items;
            scrollToTop();
            if (result.items.length == 0)
            {
                startNotification("Aucune pétition crée pour le moment");
            }
            else
            {
                var last =result.items[result.items.length - 1].key.name;
                var previousNext = API_MyPetitionCreated.next[API_MyPetitionCreated.next.length - 1];
                if (previousNext == undefined)
                {
                    previousNext =0;
                }
                if (last > previousNext)
                {
                    API_MyPetitionCreated.previous.push(previousNext);
                    API_MyPetitionCreated.next.push(last);
                }
                if (last <= previousNext && API_MyPetitionCreated.previous.length >2)
                {
                    API_MyPetitionCreated.previous.pop();
                    API_MyPetitionCreated.next.pop();
                }
            }   
        })
    }
}

//Recherche les pétitions signé par l'utilisateur
var API_MyPetitionSigned = 
{
    list: [],
    previous: ["0"],
    next: ["0"],
    loadList: function(idItem) 
    {  
        return m.request({
            method: "GET",
            url:  hostApi+"/petition/signed/:userID/:last",
            params: {userID:userConnecter.id, last: idItem}
        })
        .then(function(result) 
        {
            
            API_MyPetitionSigned.list = result.items;
            scrollToTop();
            if (result.items.length == 0)
            {
                startNotification("Aucune pétition signé pour le moment");
            }
            else
            {
                var last =result.items[result.items.length - 1].key.name;
                var previousNext = API_MyPetitionSigned.next[API_MyPetitionSigned.next.length - 1];
                if (previousNext == undefined)
                {
                    previousNext =0;
                }
                if (last > previousNext) 
                {
                    API_MyPetitionSigned.previous.push(previousNext);
                    API_MyPetitionSigned.next.push(last);
                }
                if (last <= previousNext && API_MyPetitionSigned.previous.length >2)
                {
                    API_MyPetitionSigned.previous.pop();
                    API_MyPetitionSigned.next.pop();
                }
            }
        }).catch(function(e) 
        {
            startNotification("Aucune pétition signé pour le moment");
        })
    }
}

//Permet de changer le mode de recherche de pétition : tag/titre. Permet de chercher les pétition en fonction du mode
var API_SearchPetition = 
{
    list: [],
    previous: ["0"],
    next: ["0"],
    type:"titre",
    key_search:"",
    changeType: function(type) 
    {
        API_SearchPetition.list=[];
        API_SearchPetition.previous= ["0"];
        API_SearchPetition.next= ["0"];
        API_SearchPetition.type=type;
    },
    loadList: function(idItem) 
    {
        return m.request(
            (API_SearchPetition.type =="tag")?
            {
                method: "GET",
                url:  hostApi+"/search/tag/:tag/:last",
                params: {tag: API_SearchPetition.key_search, last: idItem}
            }:{
                method: "GET",
                url:  hostApi+"/search/titre/:titre/:last",
                params: {titre: API_SearchPetition.key_search, last: idItem}
            }      
        )
        .then(function(result) 
        {
            API_SearchPetition.list = result.items;
            scrollToTop();
            if (result.items.length == 0)
            {
                startNotification("Aucun resultat trouvé");
            }
            else
            {
                var last =result.items[result.items.length - 1].key.name;
                var previousNext = API_SearchPetition.next[API_SearchPetition.next.length - 1];
                if (previousNext == undefined)
                {
                    previousNext =0;
                }
                if (last > previousNext) 
                {
                    API_SearchPetition.previous.push(previousNext);
                    API_SearchPetition.next.push(last);
                }
                if (last <= previousNext && API_SearchPetition.previous.length >2)
                {

                    API_SearchPetition.previous.pop();
                    API_SearchPetition.next.pop();
                }
            

            }
            
            
        })
    }
}

//Creation d'une pétition
var Api_CrudPetition = 
{
		item: getPetitionObject(),
		index:null,
		previous: ["0"],
		next: ["0"],
		loadList: function(idItem) {},
		createPetition: function() {
			return m.request
            ({
	            method: "POST",
	            url: hostApi+"/petition/add",
	            body: Api_CrudPetition.item,
	        })
	        .then(function(result) 
            {
	        	startNotification("Petition crée avec succès !");
	        	if (currentURL != "/MyPetitionCreated")
                {
	        		m.route.set("/MyPetitionCreated");
	        	} 
                else
                {
	        		API_MyPetitionCreated.loadList(indexMyPetitionCreatedView);
	        	}	
	        })
		},
		updatePetition: function() {
			return m.request
            ({
	            method: "POST",
	            url: hostApi+"/petition/update",
	            body: Api_CrudPetition.item,
	        })
	        .then(function(result) 
            {
	        	Api_CrudPetition.item = result.properties;
	        	Api_CrudPetition.item.ID = result.key.name;
	        	UpdatedCardPetitionInView(Api_CrudPetition.index);
	        	startNotification("Petition modifié avec succès !");
	        })
		},
		deletePetition: function(petitionID) 
        {
			return m.request
            ({
	            method: "DELETE",
	            url: hostApi+"/petition/delete/:ID",
	            params: {ID: petitionID}
	        })
	        .then(function(result) 
            {
	        	startNotification("Suppression reussie !");
	        })
		}
		
}

var indexTop10NewPetitionsView,indexTop10SignedPetitionsView,
indexMyPetitionCreatedView,indexMyPetitionSignedView,indexSearchPetitionView;

//------------------------------------------------Ensemble des variable de Vue---------------------------------------------------------
//Vue pour le top 10 des petitions par date
var Top10NewPetitionsView = 
{
    oninit: function(vnode) 
    {
        indexTop10NewPetitionsView=0;
    },
    oncreate: function(vnode) 
    {
        currentURL = "/";
        Top10NewPetitions.loadList(indexTop10NewPetitionsView);
    },
    view: function() 
    {
        return [Top10NewPetitions.list.map(function(item,index) 
{
            return m(cardPetition, {item : item,index:index})
        }),m(paginationTop10New)]
    }
}

//Vue pour le top 10 des petition par nombres de signature
var Top10SignedPetitionsView = {
		oninit: function(vnode) {
			indexTop10SignedPetitionsView =0;
		},
		  oncreate: function(vnode) {
			  currentURL = "/Top100Signed";
			  Top10SignedPetitions.pageSuivante=true;
			  Top10SignedPetitions.loadList(indexTop10SignedPetitionsView);
			  
		    },
		  view: function() {
		   	return [Top10SignedPetitions.list.map(function(item,index) {
			      return m(cardPetition, {item : item,index:index})
				    }),m(paginationTop100Signed)]
		  }
		}

//Vue pour le top 10 des petition par date
var MyPetitionCreatedView = 
{
    oninit: function(vnode) {
        indexMyPetitionCreatedView =0;
    },
    oncreate: function(vnode) {
        currentURL = "/MyPetitionCreated";
        API_MyPetitionCreated.loadList(indexMyPetitionCreatedView);
        
    },
    view: function() {
        return [API_MyPetitionCreated.list.map(function(item,index) {return m(cardPetition, {item : item,index:index}) }),m(paginationMyPetitionCreated)]
    }
}

//Vue pour la signature de la pétition
var MyPetitionSignedView = {
    oninit: function(vnode) 
    {
        indexMyPetitionSignedView =0;
    },
    oncreate: function(vnode) 
    {
        currentURL = "/MyPetitionSigned";
        API_MyPetitionSigned.loadList(indexMyPetitionSignedView); 
    },
    view: function() 
    {
        return [API_MyPetitionSigned.list.map(function(item,index) {return m(cardPetition, {item : item,index:index})}),m(paginationMyPetitionSigned)]
    }
}

//Vue pour la recherche de pétition
var SearchPetitionView = {
    oninit: function(vnode) 
    {
        indexSearchPetitionView =0;
    },
    oncreate: function(vnode) 
    {
        currentURL = "/MyPetitionSigned";
    },
    view: function() 
    {
        return [API_SearchPetition.list.map(function(item,index) {return m(cardPetition, {item : item,index:index})}),m(paginationSearchPetition)]
    }
}

//Permet de voir les informations de la pétiton
var infoPetitionView = 
{
    oncreate: function(vnode) {
        scrollToTop();
    },
    view: function() 
    {
        return m("div", {"class":"tile is-ancestor"},
            [
                m("div", {"class":"tile is-parent"},
                    [
                        m("img", {"class":"img40","src":validURL(API_infoPetition.item.img_url)?API_infoPetition.item.img_url:"https://wallpaperheart.com/wp-content/uploads/2018/04/4k-resolution-wallpapers-Ultra-HD.jpg"}),
                        m("div", {"class":"tile is-child box"},[m("p", {"class":"title"}, API_infoPetition.item.titre ),m("p", API_infoPetition.item.description)])
                    ]
                ),
                m("div", {"class":"tile is-4 is-vertical is-parent"},
                    [
                        m("div", {"class":"is-child box"},
                            [
                                m("p", {"class":"title"}, "Informations complémentaires"),
                                m("span", {"class":"w-500"}, "Auteur : "),
                                m("span", API_infoPetition.item.proprietaire),m("br"),
                                m("span", {"class":"w-500"}, "Thème : "),
                                m("span", API_infoPetition.item.theme),m("br"),
                                m("span", {"class":"w-500"}, "Date de création : "),
                                m("span", API_infoPetition.item.date),m("br"),
                                m("span", {"class":"w-500"}, "Date de dernière modification : "),
                                m("span", API_infoPetition.item.update_at),m("br")
                            ]
                        ),
                        m("div", {"class":"is-child box pb-0"},
                            [
                                m("p", {"class":"title"},"Soutenez cette pétition"),
                                m("progress", {"class":"progress is-success","value":"60","max":"100"}),
                                m("p", {"class":"has-text-centered mb-10"},
                                    [
                                        m("strong", API_infoPetition.item.nbSignataire + " personnes ont signé"),
                                        m("span", " d'un objectif de "+API_infoPetition.item.objectifSignataire+" signatures")
                                    ]
                                ),
                                m("footer", {"class":"card-footer"}, 
                                    m("p", {"class":"card-footer-item"}, 
                                        m("span", API_infoPetition.item.proprietaire == userConnecter.id?
                                            m("a", {"class":"link"}, 
                                            "Vous êtes l'auteur"
                                            ) : m("a", {"class":"link","href":"#"}, 
                                            "Signer la pétition"
                                            )
                                        )
                                    )
                                )
					        ]
					    )
					]
				)
			]
		)
	}
}

//Vue pour le détail de la pétition	
var DetailPetitionView = 
{
    view : function()
    {
        var pourcent = Math.ceil(100*API_infoPetition.item.nbSignataire/API_infoPetition.item.objectifSignataire);
        if(API_infoPetition.item.objectifSignataire == 0) {pourcent = 100;}
        return m("div", {"id":"DetailPetitionView","class":"modal full"},
            [
                m("div", {"class":"modal-background"}),
                m("div", {"class":"modal-card"}, 
                    m("form", {"class":"form"},
                        [
                            m("section", {"class":"modal-card-body"}, 
                                m("div", {"class":"tile is-ancestor"},
                                    [
                                        m("div", {"class":"tile is-parent"},
                                            [
                                                m("img", {"class":"img40","src":validURL(API_infoPetition.item.img_url)?API_infoPetition.item.img_url:"https://wallpaperheart.com/wp-content/uploads/2018/04/4k-resolution-wallpapers-Ultra-HD.jpg"}),
                                                m("div", {"class":"tile is-child box"},
                                                    [
                                                        m("p", {"class":"title"}, API_infoPetition.item.titre),
                                                        m("p",API_infoPetition.item.description)
                                                    ]
                                                )
                                            ]
                                        ),
                                        m("div", {"class":"tile is-4 is-vertical is-parent"},
                                            [
                                                m("div", {"class":"is-child box"},
                                                    [
                                                        m("p", {"class":"title"}, "Informations complémentaires"),
                                                        m("span", {"class":"w-500"}, "Auteur : "),
                                                        m("span", API_infoPetition.item.proprietaire),m("br"),
                                                        m("span", {"class":"w-500"}, "Thème : "),
                                                        m("span", API_infoPetition.item.theme),m("br"),
                                                        m("span", {"class":"w-500"}, "Date de création : "),
                                                        m("span", API_infoPetition.item.date),m("br"),
                                                        m("span", {"class":"w-500"}, "Date de dernière modification : "),
                                                        m("span", API_infoPetition.item.update_at),m("br"),
                                                        m("ul", {"class":"truncates"},
                                                            [
                                                                m("span", {"class":"w-500"}, 
                                                                    " Tag : "
                                                                ),API_infoPetition.item.tag == null? "": API_infoPetition.item.tag.map(function(item) {
                                                                        return m("span", {"class":"tag is-rounded"}, 
                                                                                item
                                                                        )
                                                                })
                                                            ]
                                                        )
                                                    ]
                                                ),
                                                m("div", {"class":"is-child box pb-0"},
                                                    [
                                                        m("p", {"class":"title"}, "Soutenez cette pétition"),
                                                        m("progress", {"class":"progress is-success","value":pourcent,"max":"100"}),
                                                        m("p", {"class":"has-text-centered mb-10"},
                                                            [
                                                                m("strong", API_infoPetition.item.nbSignataire + " personnes ont signé"),
                                                                m("span", " d'un objectif de "+API_infoPetition.item.objectifSignataire+" signatures")
                                                            ]
                                                        ),
                                                        m("footer", {"class":"card-footer"}, 
                                                            m("p", {"class":"card-footer-item"}, 
                                                                m("span",  
                                                                    m("a", 
                                                                        {"class":"link", onclick: function(e) {
                                                                            e.preventDefault();
                                                                            if(API_infoPetition.item.proprietaire == userConnecter.id)
                                                                            {
                                                                                startNotification("Operation invalide : Vous ne pouvez pas signer vos propres petitions!","is-primary","notificationDetailPetition")
                                                                            } else 
                                                                            {
                                                                                if(API_SignaturePetition.isSigned)
                                                                                {
                                                                                    API_SignaturePetition.deleteSignature(API_infoPetition.item.ID)
                                                                                    
                                                                                }else if (userConnecter.id==null)
                                                                                {
                                                                                    startNotification("Vous devez être connecté pour signer une petition");
                                                                                }
                                                                                else
                                                                                {
                                                                                    API_SignaturePetition.addSignature(API_infoPetition.item.ID)	
                                                                                }                                                                                
                                                                            }
                                                                        }}, 
                                                                        API_SignaturePetition.isSigned?"Enlever la signature":"Signer la pétition"
                                                                    )
                                                                )
                                                            )
                                                        )
                                                    ]
                                                ),
                                                m("div", {"id": "notificationDetailPetition", class: notification.classSup=="" ?"notification hide":"notification " +notification.classSup},
                                                    [
                                                        m("button", {"class":"delete",onclick: function(e) {
                                                                e.preventDefault();
                                                                closeNotification("notificationDetailPetition");
                                                        }}),
                                                        notification.message
                                                    ]
                                                )
                                            ]
                                        )
                                    ]
                                )
                            ),
                            m("button", {onclick: function(e) {e.preventDefault();HideDetailPetitionView();},"class":"modal-close is-large","aria-label":"close"})
                        ]
                    )
                )
            ]
        )
    }		
}

//Vue pour la création et la mise à jour de pétition
var CreateAndUpdatePetitionView = 
{
    view : function()
    {
        return m("div", {"id" : "CreateAndUpdatePetitionView", "class":"modal"},
            [
                m("div", {"class":"modal-background"}),
                m("div", {"class":"modal-card"}, 
                    m("form", {"class":"form scroll-y",onsubmit: function(e) 
                        {
                            e.preventDefault()
                            if(Api_CrudPetition.item.ID==null)
                            {
                                Api_CrudPetition.createPetition();
                            } else
                            {
                                Api_CrudPetition.updatePetition();
                            }
                            HideCreateAndUpdatePetitionView();      
                        }},
                        [
                            m("header", {"class":"modal-card-head"},
                                [
                                    m("p", {"class":"modal-card-title"}, "Créer une petition"),
                                    m("button", {onclick: function(e) 
                                        {e.preventDefault(); HideCreateAndUpdatePetitionView();},"class":"delete","aria-label":"close"}
                                    )
                                ]
                            ),
                            m("section", {"class":"modal-card-body"},
                                [
                                    m("div", {"class":"field "},
                                        [
                                            m("label", {"class":"label"}, "Titre"),
                                            m("div", {"class":"control"}, 
                                                m("input", {"class":"input","type":"text","placeholder":"Indiquez le titre de votre pétition",
                                                    oninput: function (e) {Api_CrudPetition.item.titre = e.target.value},
                                                    value: Api_CrudPetition.item.titre
                                                })
                                            ),
                                            m("p", {"class":"help  is-primary is-light"}, "Le titre est obligatoire")
                                        ]
                                    ),
                                    m("div", {"class":"field "},
                                        [
                                            m("label", {"class":"label"}, "Thème"),
                                            m("div", {"class":"control"}, 
                                                m("input", {"class":"input","type":"text","placeholder":"Donnez le thème general",
                                                    oninput: function (e) {Api_CrudPetition.item.theme = e.target.value},
                                                    value: Api_CrudPetition.item.theme
                                                })
                                            )
                                        ]
                                    ),
                                    m("div", {"class":"field "},
                                        [
                                            m("label", {"class":"label"}, "Tag"),
                                            m("div", {"class":"control"}, 
                                                m("input", {"class":"input","type":"text","placeholder":"Indiquez vos tags, chaque tag doit etre terminer par un point virgule ;",
                                                    oninput: function (e) {Api_CrudPetition.item.tag_string = e.target.value},
                                                    value: Api_CrudPetition.item.tag_string
                                                }),
                                                m("p", {"class":"help  is-primary is-light"}, "Max 10 tags par petition (choisissez les plus pertinents)" )
                                            )
                                        ]
                                    ),
                                    m("div", {"class":"field "},
                                        [
                                            m("label", {"class":"label"}, 
                                                "Image"
                                            ),
                                            m("div", {"class":"control"}, 
                                                m("input", {"class":"input","type":"text","placeholder":"Indiquez l'URL de votre image",
                                                    oninput: function (e) {Api_CrudPetition.item.img_url = e.target.value},
                                                    value: Api_CrudPetition.item.img_url
                                                })
                                            )
                                        ]
                                    ),
                                    m("div", {"class":"field "},
                                        [
                                            m("label", {"class":"label"}, "Nombre de signatures visés"),
                                            m("div", {"class":"control"}, 
                                                m("input", {"class":"input","type":"number","placeholder":"Indiquez le nombre de signatures que vous souhaitez atteindre",
                                                    oninput: function (e) {Api_CrudPetition.item.objectifSignataire = e.target.value},
                                                    value: Api_CrudPetition.item.objectifSignataire
                                                })
                                            )
                                        ]
                                    ),
                                    m("div", {"class":"field"},
                                        [
                                            m("label", {"class":"label"}, "Description"),
                                            m("div", {"class":"control"}, 
                                                m("textarea", {"class":"textarea ","rows":"10","placeholder":"Exprimez vous librement, et donnez tous les détails de votre pétition ",
                                                    oninput: function (e) {Api_CrudPetition.item.description = e.target.value},
                                                    value: Api_CrudPetition.item.description
                                                })
                                            ),
                                            m("p", {"class":"help  is-primary is-light"}, "La description est obligatoire")
                                        ]
                                    ),
                                    m("div", {"class":"field"}, 
                                        m("div", {"class":"control"}, 
                                            m("label", {"class":"checkbox"},
                                                [
                                                    m("input", {"type":"checkbox"}),
                                                    " Je suis d'accord avec les termes et conditions "
                                                ]
                                            )
                                        )
                                    )
                                ]
                            ),
                            m("footer", {"class":"modal-card-foot"},
                                [
                                    m("button", {"class":"button is-primary save"},"Enregister"),
                                    m("button", {onclick: function(e) 
                                        { e.preventDefault();HideCreateAndUpdatePetitionView();},"class":"button is-primary is-light cancel"},"Annuler"
                                    )
                                ]
                            )
                        ]
                    )
                )
            ]
        )
    }
}

//Variable pour l'affichage de la barre de navigation
var Header = {
		view : function(){
			
			return [m("script", {"src":"https://apis.google.com/js/platform.js","async":"async","defer":"defer"}),
				m("nav", {"class":"navbar is-fixed-top box","role":"navigation","aria-label":"main navigation"},
					  [
						    m("div", {"class":"navbar-brand"},
						      [
						        m("a", {"class":"","href":"#"}, 
						          m("img", {"class":"logo","src":"logo.png"})),
						        m("a", {"class":"navbar-burger","role":"button","aria-label":"menu","aria-expanded":"false","data-target":"navbarBasic"},
						          [ m("span", {"aria-hidden":"true"}),m("span", {"aria-hidden":"true"}),m("span", {"aria-hidden":"true"})])
						      ]
						    ),
						    m("div", {"class":"navbar-menu","id":"navbarBasic"},
						      [
						        m("div", {"class":"navbar-start"},
						          [
						            m("a", {onclick: function(e) {
						            	if (userConnecter.id==null){
						                
						                	startNotification("Vous devez être connecté pour créer une petition");
						                } else{
						                	ShowCreateAndUpdatePetitionView();
						                }
						            	
						            },"class":"navbar-item fw-500"},  " Créer une petition "),
						            m(m.route.Link, {href: "/MyPetitionCreated",onclick: function(e) {
						            	currentURL = '/MyPetitionCreated';
						            }, class: currentURL == "/MyPetitionCreated" || currentURL == "/MyPetitionSigned" ? "navbar-item fw-500 is-active" : "navbar-item fw-500"},  "Mes petitions"),
						          
						            m(m.route.Link, {href: "/",onclick: function(e) {
						            	currentURL = '/';
						            }, class: currentURL == "/" || currentURL == "/Top100Signed" ? "navbar-item fw-500 is-active" : "navbar-item fw-500"},  "Parcourir les pétitions")
						          ]
						        ),
						        m("div", {"class":"navbar-end"}, 
						          m("div", {"class":"navbar-item"}, 
						            m("div", {"class":"buttons"},
						              [
						            	  m("div", {"id": "notification",onclick: function(e) {
							            	  e.preventDefault();
								            	closeNotification("notification");
								            }, class: notification.classSup=="" ?"notification hide":"notification " +notification.classSup},
						            		  [
						            			    m("button", {"class":"delete"}),
						            			    notification.message
						            			  ]
						            			),
						            	m(m.route.Link, {href: "/SearchPetition",onclick: function(e) {
							            	currentURL = '/SearchPetition';
							            }, "class":"button is-primary" }, m("i", {"class":"fas fa-search"})),
						                m("div", {"id":"login_google","class":"g-signin2","data-onsuccess":"onSignIn"}),
						                m("a", {"id":"logout_google",class: userConnecter.id==null?"button is-light hide":"button is-light",onclick: function(e) {
						                	signOut();
							            }}, 
						                  m("strong", 
						                    "Se deconnecter"
						                  )
						                ),
						                
						              ]
						            )
						          )
						        )
						      ]
						    )
						  ]
						),
						m(CreateAndUpdatePetitionView),m(DetailPetitionView)
			]
		}
		
}
var TabParcourirPetition = {
		   view: function() {
		   	return [
		   	  m("hr", {"class":"m-0 p-22"}), 
		   	  m("br"), 
		   	  m("h2", {"class":"title is-2 has-text-centered"}, 
		   	    "Découvrir des pétitions"
		   	  ), 
		   	  m("div", {"class":"tabs is-centered m-0"}, 
		   	    m("ul",
		   	      [
		   	        m("li", {class: currentURL == "/" ? "is-active" : ""}, m(m.route.Link, {href: "/",onclick: function(e) {
		            	currentURL = '/';
		            }},  "Les pétitions récentes")),
		   	        m("li", {class: currentURL == "/Top100Signed" ? "is-active" : ""}, m(m.route.Link, {href: "/top100Signed",onclick: function(e) {
		            	currentURL = '/Top100Signed';
		            }},  "Top pétitions signés"))
		   	         
		   	      ]
		   	    )
		   	  )
		   	]
		   }
}
var TabMyPetitionCreated = {
		   view: function() {
			   	return [
			   	  m("hr", {"class":"m-0 p-22"}), 
			   	  m("br"), 
			   	  m("h2", {"class":"title is-2 has-text-centered"}, 
			   	    "Bienvenue, "+userConnecter.prenom.toLowerCase()
			   	  ), 
			   	  m("div", {"class":"tabs is-centered m-0"}, 
			   	    m("ul",
			   	      [
			   	        m("li", {class: currentURL == "/MyPetitionCreated" ? "is-active" : ""}, m(m.route.Link, {href: "/MyPetitionCreated",onclick: function(e) {
			            	currentURL = '/MyPetitionCreated';
			            }},  "Pétition(s) lancée(s)")),
			   	        m("li", {class: currentURL == "/MyPetitionSigned" ? "is-active" : ""}, m(m.route.Link, {href: "/MyPetitionSigned",onclick: function(e) {
			            	currentURL = '/MyPetitionSigned';
			            }},  "Pétition(s) signée(s)"))
			   	         
			   	      ]
			   	    )
			   	  )
			   	]
			   }
	}

var TabMyPetitionSigned = TabMyPetitionCreated;

var TabSearchPetition = {
		   view: function() {
			   	return [
			   	  m("hr", {"class":"m-0 p-22"}), 
			   	  m("br"), 
			   	  m("h2", {"class":"title is-2 has-text-centered"}, 
			   	    "Recherchez des pétitions"
			   	  ), 
			   	  m("div", {"class":"panel-block search"},
			   	    [
			   	      m("p", {"class":"control txt-center"},
			   	        [
			   	          m("input", {"class":"input is-primary txt-center w-60 ","type":"text","placeholder":"Indiquez le titre ou l'un des tags de la petition recherchée",
		                        oninput: function (e) {API_SearchPetition.key_search = e.target.value},
		                        value: API_SearchPetition.key_search
		                    }),
			   	          m("a", {"class":"link dark",
					            onclick: function(e) {
					                
					            	API_SearchPetition.loadList(0);
					                
					                
					            }}, 
			   	            m("span", {"class":"icon mt-8"}, 
			   	              m("i", {"class":"fas fa-search","aria-hidden":"true"})
			   	            )
			   	          )
			   	        ]
			   	      ),
			   	      m("div", {"class":"tabs is-toggle is-toggle-rounded"}, 
			   	        m("ul",
			   	          [
			   	            m("li", {class:API_SearchPetition.type=="tag"?"is-active":""}, 
			   	              m("a",{
						            onclick: function(e) {
						                
						            	API_SearchPetition.type=="tag"?"":API_SearchPetition.changeType("tag");
						                
						                
						            }}, 
			   	                m("span", 
			   	                  "Tag"
			   	                )
			   	              )
			   	            ),
			   	            m("li", {class:API_SearchPetition.type=="titre"?"is-active":""}, 
			   	              m("a",{
						            onclick: function(e) {
						                
						            	API_SearchPetition.changeType("titre");
						                
						                
						            }}, 
			   	                m("span", 
			   	                  "Titre"
			   	                )
			   	              )
			   	            )
			   	          ]
			   	        )
			   	      )
			   	    ]
			   	  )
			   	]
			   }
}

//Affichage des informations de la pétitions
var TabDetailPetition =
{
	view: function() 
    {
        return 
        [
            m("hr", {"class":"m-0 p-22"}), 
            m("br"), 
            m("h2", {"class":"title is-2 has-text-centered"}, "Détails de la pétition"), 
            m("div", {"class":"tabs is-centered m-0"}, 
                m("ul", {"class":"scroll-x"},
                    [
                        m("span", {"class":"w-500"}, " Liste de tags : "),
                        API_infoPetition.item.tag == null? "": API_infoPetition.item.tag.map(function(item) 
                        {
                                return m("span", {"class":"tag is-rounded"}, item)
                        })
                    ]
                )
            )
        ]
	}
}

//Affichage pour une pétition
var cardPetition = 
{
    view: function(vnode) 
    {
        var item =  vnode.attrs.item;
        var index =  vnode.attrs.index;
        var pourcent = Math.ceil(100*item.properties.nbSignataire/item.properties.objectifSignataire);
        if(item.properties.objectifSignataire == 0) 
        {
            pourcent = 100;
        }
        
        return m("div", {class: item.deleted !=null? "card slider closed":"card slider"},
            [
                m("div", {"class":"card-content"},
                    [
                        m("img", {"src":validURL(item.properties.img_url)?item.properties.img_url:"https://wallpaperheart.com/wp-content/uploads/2018/04/4k-resolution-wallpapers-Ultra-HD.jpg"}),
                        m("p", {"class":"title"}, item.properties.titre),
                        m("p", {"class":"subtitle truncate"}, item.properties.description ),
                        m("progress", {"class":"progress is-success","value":pourcent,"max":"100"}),
                        m("p", {"class":"has-text-centered"},
                            [
                            m("strong", item.properties.nbSignataire+" personnes ont signé "),
                            m("span", "d'un objectif de "+ item.properties.objectifSignataire +" signatures")
                            ]
                        )
                    ]
                ),
                m("footer", {"class":"card-footer"}, 
                    item.properties.proprietaire == userConnecter.id?
                    [
                        m("p", {"class":"card-footer-item"}, 
                            m("span",
                                m("a", {"class":"link",
                                onclick: function(e) 
                                {
                                    item.deleted= true;
                                    Api_CrudPetition.deletePetition(item.key.name);
                                }}, 
                                [
                                    m("span", {class : ""}, "Supprimer")
                                ]) 
                            )
                        ),
                        m("p", {"class":"card-footer-item"}, 
                            m("span",
                                m("a", {"class":"link",
                                    onclick: function(e) 
                                    {
                                        if (userConnecter.id==null)
                                        {   
                                            startNotification("Vous devez être connecté pour modifier une petition");
                                        } else
                                        {
                                            ShowCreateAndUpdatePetitionView(item.key.name,index);
                                        }
                                    }}, 
                                    [
                                        m("span", {class : ""}, "Modifier")
                                    ]
                                ) 
                            )
                        )
                    ]:"",
                    m("p", {"class":"card-footer-item"}, 
                        m("span",
                            m("a", {"class":"link",
                            onclick: function(e) 
                            {
                                API_infoPetition.index=index;
                                API_infoPetition.loadPetition(item.key.name)
                                API_SignaturePetition.verifieSignature(item.key.name);
                                ShowDetailPetitionView();
                            }}, 
                            [
                                m("span", {class : ""}, "Voir la pétition")
                            ]) 
                        )
                    )
                )
            ]
        )
    }
}

//Vue pour le top 100 des pétitions par date de création
var paginationTop10New = 
{
    view: function() 
    {
        return Top10NewPetitions.list.length<10? "":m("nav", {"class":"pagination is-rounded","role":"navigation","aria-label":"pagination"},
            [
                m(m.route.Link, {"class":"pagination-previous", href: "/",onclick: function(e) {
                    indexTop10NewPetitionsView = Top10NewPetitions.previous[Top10NewPetitions.previous.length - 2];
                    if (indexTop10NewPetitionsView == undefined){
                        indexTop10NewPetitionsView =0;
                    }
                    Top10NewPetitions.loadList(indexTop10NewPetitionsView)
                }},  "Page précédente"),
                m(m.route.Link, {"class":"pagination-next", href: "/",onclick: function(e) {
                    indexTop10NewPetitionsView = Top10NewPetitions.next[Top10NewPetitions.next.length - 1];
                    Top10NewPetitions.loadList(indexTop10NewPetitionsView)
                }},  "Page suivante")
            ]
        )
    }
}

//Vue pour le top 100 des pétitions avec le plus de signature 
var paginationTop100Signed= {
    view: function() 
    {
        return Top10SignedPetitions.list.length<10? "":m("nav", {"class":"pagination is-rounded","role":"navigation","aria-label":"pagination"},
            [
                
                m(m.route.Link, {"class":"pagination-previous", href: "/top100Signed",onclick: function(e) {
                    indexTop10SignedPetitionsView = Top10SignedPetitions.previous[Top10SignedPetitions.previous.length - 2];
                    Top10SignedPetitions.pageSuivante=false;
                    Top10SignedPetitions.loadList(indexTop10SignedPetitionsView);
                    
                }},  "Page précédente"),
                m(m.route.Link, {"class":"pagination-next", href: "/top100Signed",onclick: function(e) {
                    indexTop10SignedPetitionsView = Top10SignedPetitions.next[Top10SignedPetitions.next.length - 1];

                    Top10SignedPetitions.pageSuivante=true;
                    Top10SignedPetitions.loadList(indexTop10SignedPetitionsView);
                }},  "Page suivante")
            ]
        )
	}
}

//Vue pour l'affichage des pétition créer par l'utilisateur
var paginationMyPetitionCreated = 
{
    view: function() 
    {
        return API_MyPetitionCreated.list.length<10? "":m("nav", {"class":"pagination is-rounded","role":"navigation","aria-label":"pagination"},
            [      
                m(m.route.Link, {"class":"pagination-previous", href: "/",onclick: function(e) {
                    indexMyPetitionCreatedView = API_MyPetitionCreated.previous[API_MyPetitionCreated.previous.length - 2];
                    if (indexMyPetitionCreatedView == undefined){
                        indexMyPetitionCreatedView =0;
                    }
                    API_MyPetitionCreated.loadList(indexMyPetitionCreatedView)
                }},  "Page précédente"),
                m(m.route.Link, {"class":"pagination-next", href: "/",onclick: function(e) {
                    indexMyPetitionCreatedView = API_MyPetitionCreated.next[API_MyPetitionCreated.next.length - 1];

                    API_MyPetitionCreated.loadList(indexMyPetitionCreatedView)
                }},  "Page suivante")
            ]
        )
    }
}

//Vue pour la liste des pétions signées par l'utilisateur
var paginationMyPetitionSigned = 
{
    view: function() 
    {
        return API_MyPetitionSigned.list.length<10? "":m("nav", {"class":"pagination is-rounded","role":"navigation","aria-label":"pagination"},
            [
                m(m.route.Link, {"class":"pagination-previous", href: "/",onclick: function(e) {
                    indexMyPetitionSignedView = API_MyPetitionSigned.previous[API_MyPetitionSigned.previous.length - 2];
                    if (indexMyPetitionSignedView == undefined){
                        indexMyPetitionSignedView =0;
                    }

                    
                    API_MyPetitionSigned.loadList(indexMyPetitionSignedView)
                    
                }},  "Page précédente"),
                m(m.route.Link, {"class":"pagination-next", href: "/",onclick: function(e) {
                    indexMyPetitionSignedView = API_MyPetitionSigned.next[API_MyPetitionSigned.next.length - 1];

                    API_MyPetitionSigned.loadList(indexMyPetitionSignedView)
                }},  "Page suivante")
            ]
        )
    }
}

//Vue pour la recherche de pétition 
var paginationSearchPetition = 
{
    view: function() 
    {
        return API_SearchPetition.list.length<10? "":m("nav", {"class":"pagination is-rounded","role":"navigation","aria-label":"pagination"},
            [
                m(m.route.Link, {"class":"pagination-previous", href: "/",onclick: function(e) {
                    indexSearchPetitionView = API_SearchPetition.previous[API_SearchPetition.previous.length - 2];
                    if (indexSearchPetitionView == undefined){
                        indexSearchPetitionView =0;
                    }
                    API_SearchPetition.loadList(indexSearchPetitionView)
                    
                }},  "Page précédente"),
                m(m.route.Link, {"class":"pagination-next", href: "/",onclick: function(e) {
                    indexSearchPetitionView = API_SearchPetition.next[API_SearchPetition.next.length - 1];
                    API_SearchPetition.loadList(indexSearchPetitionView)
                }},  "Page suivante")
            ]
        )
    }
}


var Home = 
{
    view: function() 
    {
        return [m(Header),m(TabParcourirPetition),m('div', {class:'p-30 cendre'}, [ m(Top10NewPetitionsView)])]
    }
}	
var Top100Signed = 
{
    view: function() 
    {
        return [m(Header),m(TabParcourirPetition),m('div', {class:'p-30 cendre'}, [m(Top10SignedPetitionsView)])]
    }
}
var infoPetition = 
{
    view: function() 
    {
        return [m(Header),m(TabDetailPetition),m('div', {class:'p-30 cendre'}, [m(infoPetitionView)])]
    }
}
	
var MyPetitionCreated = 
{
    view: function() 
    {
        return [m(Header),m(TabMyPetitionCreated), m('div', {class:'p-30 cendre'}, [m(MyPetitionCreatedView)])]
    }
}

var MyPetitionSigned = 
{
    view: function() 
    {
        return [m(Header),m(TabMyPetitionSigned),m('div', {class:'p-30 cendre'}, [m(MyPetitionSignedView)])]
    }
}

var SearchPetition = {
	view: function() 
    {
		return [m(Header),m(TabSearchPetition),m('div', {class:'p-30 cendre'}, [m(SearchPetitionView)])]
	}
}
//--------------------------------------------------------------------------------------------------------------------------------
   
//affichage du corp en fonction de l'url
m.route(document.body, "/", 
{
    "/": Home,
    "/top100Signed" : Top100Signed,
    "/MyPetitionCreated": {
        onmatch: function() 
        {
            if (userConnecter.id==null)
            {
            	m.route.set("/")
            	currentURL="/"
            	startNotification("Vous devez être connecté pour accéder à vos petitions");
            }
            else return MyPetitionCreated
        }
    },
    "/MyPetitionSigned": 
    {
        onmatch: function() 
        {
            if (userConnecter.id==null)
            {
            	m.route.set("/")
            	currentURL="/"
            	startNotification("Vous devez être connecté pour accéder à vos petitions");
            }
            else return MyPetitionSigned
        }
    },
    "/SearchPetition": SearchPetition,
})
</script>
</body>
</html>